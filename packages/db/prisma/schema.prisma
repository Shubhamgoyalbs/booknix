generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

//----//
// Enums

enum Role {
  USER
  ORGANIZER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  EXPIRED
  REFUNDED
}

enum EventType {
  CONCERT
  COMEDY
  SPORTS
  THEATER
  CONFERENCE
  WORKSHOP
  FESTIVAL
}

enum EventStatus {
  DRAFT
  OPEN
  BOOKING_STARTED
  CANCELLED
  CLOSED
}

enum TransactionType {
  CREDIT
  DEBIT
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

//----//
// Models

model Account {
  id           String  @id @default(cuid())
  email        String  @unique
  firstName    String
  lastName     String
  password     String
  refreshToken String?
  isVerified   Boolean @default(false)
  avatarUrl    String
  role         Role

  wallet Wallet?

  user      User?
  organizer Organizer?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Wallet {
  id String @id @default(cuid())

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id])

  totalBalance Int @default(0)
  refunds      Int @default(0)
  cashback     Int @default(0)

  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// every thing in transaction is in cents
model Transaction {
  id String @id @default(cuid())

  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id])

  bookingId String?
  booking   Booking? @relation(fields: [bookingId], references: [id])

  amount      Int
  type        TransactionType
  status      TransactionStatus @default(PENDING)
  description String?
  metadata    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id String @id @default(cuid())

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id])

  reviews       Review[]
  bookings      Booking[]
  follows       OrganizerFollow[]
  subscriptions EventSubscription[]
  bookmarks     EventBookmark[]
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Organization {
  id               String @id @default(cuid())
  organizationName String @unique

  members Organizer[]
  events  Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Organizer {
  id String @id @default(cuid())

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  followers OrganizerFollow[]
  checkers  EventTicketChecker[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Event {
  id          String   @id @default(cuid())
  title       String
  description String
  bannerUrl   String?
  gallery     String[]
  location    String
  venue       String
  onDate      DateTime
  timezone    String
  duration    Float

  eventType   EventType
  eventStatus EventStatus @default(DRAFT)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  ticketTypes         TicketType[]
  reviews             Review[]
  subscribers         EventSubscription[]
  bookmarks           EventBookmark[]
  coupons             Coupon[]
  eventTicketCheckers EventTicketChecker[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Review {
  id      String  @id @default(cuid())
  rating  Int
  message String?

  eventId String
  event   Event  @relation(fields: [eventId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, eventId])
}

model TicketType {
  id String @id @default(cuid())

  eventId String
  event   Event  @relation(fields: [eventId], references: [id])

  name        String
  description String?

  total  Int
  locked Int @default(0)
  booked Int @default(0)

  price Int

  bookingItems  BookingItem[]
  lockedTickets LockedTicket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  title   String
  message String
  isRead  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Booking {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  totalAmount Int
  finalAmount Int
  platformFee Int

  couponId String?
  coupon   Coupon? @relation(fields: [couponId], references: [id])

  expiresAt DateTime

  status BookingStatus @default(PENDING)

  bookingItems BookingItem[]
  transactions Transaction[]
  lockedItems  LockedItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BookingItem {
  id String @id @default(cuid())

  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id])

  ticketTypeId String
  ticketType   TicketType @relation(fields: [ticketTypeId], references: [id])

  quantity Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LockedItem {
  id String @id @default(cuid())

  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id])

  lockedTickets LockedTicket[]

  expiresAt  DateTime
  isReleased Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
}

model LockedTicket {
  id String @id @default(cuid())

  ticketTypeId String
  ticketType   TicketType @relation(fields: [ticketTypeId], references: [id])

  lockedItemId String
  lockedItem   LockedItem @relation(fields: [lockedItemId], references: [id])

  quantity  Int
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Coupon {
  id          String @id @default(cuid())
  description String
  name        String

  value       Int
  minPurchase Int
  maxDiscount Int

  usageLimit Int
  usageCount Int @default(0)

  validFrom  DateTime
  validUntil DateTime
  isActive   Boolean  @default(true)

  eventId String
  event   Event  @relation(fields: [eventId], references: [id])

  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventTicketChecker {
  id String @id @default(cuid())

  eventId String
  event   Event  @relation(fields: [eventId], references: [id])

  organizerId String
  organizer   Organizer @relation(fields: [organizerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, organizerId])
}

model OrganizerFollow {
  id String @id @default(cuid())

  userId      String
  organizerId String

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizer Organizer @relation(fields: [organizerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, organizerId])
  @@index([organizerId])
}

model EventSubscription {
  id String @id @default(cuid())

  userId  String
  eventId String

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, eventId])
  @@index([eventId])
}

model EventBookmark {
  id String @id @default(cuid())

  userId  String
  eventId String

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, eventId])
  @@index([eventId])
}
